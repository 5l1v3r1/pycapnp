
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Quickstart &mdash; capnp 0.4.0-dev documentation</title>
    
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.4.0-dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="capnp 0.4.0-dev documentation" href="index.html" />
    <link rel="next" title="API Reference" href="capnp.html" />
    <link rel="prev" title="Installation" href="install.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="capnp.html" title="API Reference"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="install.html" title="Installation"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">capnp 0.4.0-dev documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="quickstart">
<span id="id1"></span><h1>Quickstart<a class="headerlink" href="#quickstart" title="Permalink to this headline">¶</a></h1>
<p>This assumes you already have the capnp library installed. If you don&#8217;t, please follow the instructions at <a class="reference internal" href="install.html#install"><em>Installation</em></a> first.</p>
<p>In general, this library is a very light wrapping of the <a class="reference external" href="http://kentonv.github.io/capnproto/cxx.html">Cap&#8217;n Proto C++ library</a>. You can refer to its docs for more advanced concepts, or just to get a basic idea of how the python library is structured.</p>
<div class="section" id="load-a-cap-n-proto-schema">
<h2>Load a Cap&#8217;n Proto Schema<a class="headerlink" href="#load-a-cap-n-proto-schema" title="Permalink to this headline">¶</a></h2>
<p>First you need to import the library:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">capnp</span>
</pre></div>
</div>
<p>Then you can load the Cap&#8217;n Proto schema with:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">addressbook_capnp</span>
</pre></div>
</div>
<p>This will look all through all the directories in your sys.path/PYTHONPATH, and try to find a file of the form &#8216;addressbook.capnp&#8217;. If you want to disable the import hook magic that <cite>import capnp</cite> adds, and load manually, here&#8217;s how:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">capnp</span><span class="o">.</span><span class="n">remove_import_hook</span><span class="p">()</span>
<span class="n">addressbook_capnp</span> <span class="o">=</span> <span class="n">capnp</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s">&#39;addressbook.capnp&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>For future reference, here is the Cap&#8217;n Proto schema. Also available in the github repository under <a class="reference external" href="https://github.com/jparyani/pycapnp/tree/master/examples">examples/addressbook.capnp</a>:</p>
<div class="highlight-python"><pre># addressbook.capnp
0x934efea7f017fff0;

const qux :UInt32 = 123;

struct Person {
  id @0 :UInt32;
  name @1 :Text;
  email @2 :Text;
  phones @3 :List(PhoneNumber);

  struct PhoneNumber {
    number @0 :Text;
    type @1 :Type;

    enum Type {
      mobile @0;
      home @1;
      work @2;
    }
  }

  employment @4 union {
    unemployed @5 :Void;
    employer @6 :Text;
    school @7 :Text;
    selfEmployed @8 :Void;
    # We assume that a person is only one of these.
  }
}

struct AddressBook {
  people @0 :List(Person);
}</pre>
</div>
<div class="section" id="const-values">
<h3>Const values<a class="headerlink" href="#const-values" title="Permalink to this headline">¶</a></h3>
<p>Const values show up just as you&#8217;d expect under the loaded schema. For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">print</span> <span class="n">addressbook_capnp</span><span class="o">.</span><span class="n">qux</span>
<span class="c"># 123</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="build-a-message">
<h2>Build a message<a class="headerlink" href="#build-a-message" title="Permalink to this headline">¶</a></h2>
<div class="section" id="initialize-a-new-cap-n-proto-object">
<h3>Initialize a New Cap&#8217;n Proto Object<a class="headerlink" href="#initialize-a-new-cap-n-proto-object" title="Permalink to this headline">¶</a></h3>
<p>Now that you have a message buffer, you need to allocate an actual object that is from your schema. In this case, we will allocate an <cite>AddressBook</cite>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">addresses</span> <span class="o">=</span> <span class="n">addressbook_capnp</span><span class="o">.</span><span class="n">AddressBook</span><span class="o">.</span><span class="n">new_message</span><span class="p">()</span>
</pre></div>
</div>
<p>Notice that we used <cite>addressbook_capnp</cite> from the previous section: <a class="reference internal" href="#load-a-cap-n-proto-schema">Load a Cap&#8217;n Proto Schema</a>.</p>
<p>Also as a shortcut, you can pass keyword arguments to the <cite>new_message</cite> function, and those fields will be set in the new message:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">person</span> <span class="o">=</span> <span class="n">addressbook_capnp</span><span class="o">.</span><span class="n">Person</span><span class="o">.</span><span class="n">new_message</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;alice&#39;</span><span class="p">)</span>
<span class="c"># is equivalent to:</span>
<span class="n">person</span> <span class="o">=</span> <span class="n">addressbook_capnp</span><span class="o">.</span><span class="n">Person</span><span class="o">.</span><span class="n">new_message</span><span class="p">()</span>
<span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#39;alice&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="list">
<h3>List<a class="headerlink" href="#list" title="Permalink to this headline">¶</a></h3>
<p>Allocating a list inside of an object requires use of the <cite>init</cite> function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">people</span> <span class="o">=</span> <span class="n">addresses</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="s">&#39;people&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>For now, let&#8217;s grab the first element out of this list and assign it to a variable named <cite>alice</cite>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">alice</span> <span class="o">=</span> <span class="n">people</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It is a very bad idea to call <cite>init</cite> more than once. Every call to <cite>init</cite> allocates new memory inside your Cap&#8217;n Proto message, and if you call it more than once, the previous memory is leaked.</p>
</div>
</div>
<div class="section" id="primitive-types">
<h3>Primitive Types<a class="headerlink" href="#primitive-types" title="Permalink to this headline">¶</a></h3>
<p>For all primitive types, from the Cap&#8217;n Proto docs:</p>
<ul class="simple">
<li>Boolean: Bool</li>
<li>Integers: Int8, Int16, Int32, Int64</li>
<li>Unsigned integers: UInt8, UInt16, UInt32, UInt64</li>
<li>Floating-point: Float32, Float64</li>
<li>Blobs: Text, Data</li>
</ul>
<p>You can assign straight to the variable with the corresponding Python type. For Blobs, you use strings. Assignment happens just by using the <cite>.</cite> syntax on the object you contstructed above:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">alice</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">123</span>
<span class="n">alice</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#39;Alice&#39;</span>
<span class="n">alice</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s">&#39;alice@example.com&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="enums">
<h3>Enums<a class="headerlink" href="#enums" title="Permalink to this headline">¶</a></h3>
<p>First we&#8217;ll allocate a length one list of phonenumbers for <cite>alice</cite>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">alicePhone</span> <span class="o">=</span> <span class="n">alice</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="s">&#39;phones&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>Note that even though it was a length 1 list, it was still a list that was returned, and we extracted the first (and only) element with <cite>[0]</cite>.</p>
<p>Enums are treated like strings, and you assign to them like they were a Text field:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">alicePhone</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s">&#39;mobile&#39;</span>
</pre></div>
</div>
<p>If you assign an invalid value to one, you will get a ValueError:</p>
<div class="highlight-python"><pre>alicePhone.type = 'foo'
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
...
ValueError: src/capnp/schema.c++:326: requirement not met: enum has no such enumerant; name = foo</pre>
</div>
</div>
<div class="section" id="unions">
<h3>Unions<a class="headerlink" href="#unions" title="Permalink to this headline">¶</a></h3>
<p>For the most part, you just treat them like structs:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">alice</span><span class="o">.</span><span class="n">employment</span><span class="o">.</span><span class="n">school</span> <span class="o">=</span> <span class="s">&quot;MIT&quot;</span>
</pre></div>
</div>
<p>Now the <cite>school</cite> field is the active part of the union, and we&#8217;ve assigned <cite>&#8216;MIT&#8217;</cite> to it. You can query which field is set in a union with <cite>which()</cite>, shown in <a class="reference internal" href="#reading-unions">Reading Unions</a></p>
<p>Also, one weird case is for Void types in Unions (and in general, but Void is really only used in Unions). For these, you will have to assign <cite>None</cite> to them:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">bob</span><span class="o">.</span><span class="n">employment</span><span class="o">.</span><span class="n">unemployed</span> <span class="o">=</span> <span class="bp">None</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>One caveat for unions is having structs as union members. Let us assume <cite>employment.school</cite> was actually a struct with a field of type <cite>Text</cite> called <cite>name</cite>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">alice</span><span class="o">.</span><span class="n">employment</span><span class="o">.</span><span class="n">school</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MIT&quot;</span>
<span class="c"># Raises a ValueError</span>
</pre></div>
</div>
<p>The problem is that a struct within a union isn&#8217;t initialized automatically. You have to do the following:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">school</span> <span class="o">=</span> <span class="n">alice</span><span class="o">.</span><span class="n">employment</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="s">&#39;school&#39;</span><span class="p">)</span>
<span class="n">school</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MIT&quot;</span>
</pre></div>
</div>
<p class="last">Note that this is similar to <cite>init</cite> for lists, but you don&#8217;t pass a size. Requiring the <cite>init</cite> makes it more clear that a memory allocation is occurring, and will hopefully make you mindful that you shouldn&#8217;t set more than 1 field inside of a union, else you risk a memory leak</p>
</div>
</div>
<div class="section" id="writing-to-a-file">
<h3>Writing to a File<a class="headerlink" href="#writing-to-a-file" title="Permalink to this headline">¶</a></h3>
<p>Once you&#8217;re done assigning to all the fields in a message, you can write it to a file like so:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;example.bin&#39;</span><span class="p">,</span> <span class="s">&#39;w+b&#39;</span><span class="p">)</span>
<span class="n">addresses</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
<p>There is also a <cite>write_packed</cite> function, that writes out the message more space-efficientally. If you use write_packed, make sure to use read_packed when reading the message.</p>
</div>
</div>
<div class="section" id="read-a-message">
<h2>Read a message<a class="headerlink" href="#read-a-message" title="Permalink to this headline">¶</a></h2>
<div class="section" id="reading-from-a-file">
<h3>Reading from a file<a class="headerlink" href="#reading-from-a-file" title="Permalink to this headline">¶</a></h3>
<p>Much like before, you will have to de-serialize the message from a file descriptor:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;example.bin&#39;</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
<span class="n">addresses</span> <span class="o">=</span> <span class="n">addressbook_capnp</span><span class="o">.</span><span class="n">AddressBook</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that this very much needs to match the type you wrote out. In general, you will always be sending the same message types out over a given channel or you should wrap all your types in an unnamed union. Unnamed unions are defined in the .capnp file like so:</p>
<div class="highlight-python"><pre>struct Message {
    union {
      person @0 :Person;
      addressbook @1 :AddressBook;
    }
}</pre>
</div>
</div>
<div class="section" id="reading-fields">
<h3>Reading Fields<a class="headerlink" href="#reading-fields" title="Permalink to this headline">¶</a></h3>
<p>Fields are very easy to read. You just use the <cite>.</cite> syntax as before. Lists behave just like normal Python lists:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">addresses</span><span class="o">.</span><span class="n">people</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="n">person</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">phone</span> <span class="ow">in</span> <span class="n">person</span><span class="o">.</span><span class="n">phones</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">phone</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="n">phone</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="reading-unions">
<h3>Reading Unions<a class="headerlink" href="#reading-unions" title="Permalink to this headline">¶</a></h3>
<p>The only tricky one is unions, where you need to call <cite>.which()</cite> to determine the union type. The <cite>.which()</cite> call returns an enum, ie. a string, corresponding to the field name:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">which</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="n">employment</span><span class="o">.</span><span class="n">which</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">which</span><span class="p">)</span>

<span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&#39;unemployed&#39;</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;unemployed&#39;</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&#39;employer&#39;</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;employer:&#39;</span><span class="p">,</span> <span class="n">person</span><span class="o">.</span><span class="n">employment</span><span class="o">.</span><span class="n">employer</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&#39;school&#39;</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;student at:&#39;</span><span class="p">,</span> <span class="n">person</span><span class="o">.</span><span class="n">employment</span><span class="o">.</span><span class="n">school</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&#39;selfEmployed&#39;</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;self employed&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="serializing-deserializing">
<h2>Serializing/Deserializing<a class="headerlink" href="#serializing-deserializing" title="Permalink to this headline">¶</a></h2>
<div class="section" id="files">
<h3>Files<a class="headerlink" href="#files" title="Permalink to this headline">¶</a></h3>
<p>As shown in the examples above, there is file serialization with <cite>write()</cite>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">addresses</span> <span class="o">=</span> <span class="n">addressbook_capnp</span><span class="o">.</span><span class="n">AddressBook</span><span class="o">.</span><span class="n">new_message</span><span class="p">()</span>
<span class="o">...</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;example.bin&#39;</span><span class="p">,</span> <span class="s">&#39;w+b&#39;</span><span class="p">)</span>
<span class="n">addresses</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
<p>And similarly for reading:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;example.bin&#39;</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
<span class="n">addresses</span> <span class="o">=</span> <span class="n">addressbook_capnp</span><span class="o">.</span><span class="n">AddressBook</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
<p>There are packed versions as well:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">addresses</span><span class="o">.</span><span class="n">write_packed</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">addresses</span> <span class="o">=</span> <span class="n">addressbook_capnp</span><span class="o">.</span><span class="n">AddressBook</span><span class="o">.</span><span class="n">read_packed</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="multi-message-files">
<h3>Multi-message files<a class="headerlink" href="#multi-message-files" title="Permalink to this headline">¶</a></h3>
<p>The above methods only guaranteed to work if your file contains a single message. If you have more than 1 message serialized sequentially in your file, then you need to use these convenience functions:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">addresses</span> <span class="o">=</span> <span class="n">addressbook_capnp</span><span class="o">.</span><span class="n">AddressBook</span><span class="o">.</span><span class="n">new_message</span><span class="p">()</span>
<span class="o">...</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;example.bin&#39;</span><span class="p">,</span> <span class="s">&#39;w+b&#39;</span><span class="p">)</span>
<span class="n">addresses</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="n">addresses</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="n">addresses</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="c"># write 3 messages</span>
<span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">for</span> <span class="n">addresses</span> <span class="ow">in</span> <span class="n">addressbook_capnp</span><span class="o">.</span><span class="n">AddressBook</span><span class="o">.</span><span class="n">read_multiple</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="k">print</span> <span class="n">addresses</span>
</pre></div>
</div>
<p>There is also a packed version:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">for</span> <span class="n">addresses</span> <span class="ow">in</span> <span class="n">addressbook_capnp</span><span class="o">.</span><span class="n">AddressBook</span><span class="o">.</span><span class="n">read_multiple_packed</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="k">print</span> <span class="n">addresses</span>
</pre></div>
</div>
</div>
<div class="section" id="dictionaries">
<h3>Dictionaries<a class="headerlink" href="#dictionaries" title="Permalink to this headline">¶</a></h3>
<p>There is a convenience method for converting Cap&#8217;n Proto messages to a dictionary. This works for both Builder and Reader type messages:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">alice</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
</pre></div>
</div>
<p>For the reverse, all you have to do is pass keyword arguments to the new_message constructor:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">my_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;name&#39;</span> <span class="p">:</span> <span class="s">&#39;alice&#39;</span><span class="p">}</span>
<span class="n">alice</span> <span class="o">=</span> <span class="n">addressbook</span><span class="o">.</span><span class="n">Person</span><span class="o">.</span><span class="n">new_message</span><span class="p">(</span><span class="o">**</span><span class="n">my_dict</span><span class="p">)</span>
<span class="c"># equivalent to: alice = addressbook.Person.new_message(name=&#39;alice&#39;)</span>
</pre></div>
</div>
</div>
<div class="section" id="byte-strings-buffers">
<h3>Byte Strings/Buffers<a class="headerlink" href="#byte-strings-buffers" title="Permalink to this headline">¶</a></h3>
<p>There is serialization to a byte string available:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">encoded_message</span> <span class="o">=</span> <span class="n">alice</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">()</span>
</pre></div>
</div>
<p>And a corresponding from_bytes function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">alice</span> <span class="o">=</span> <span class="n">addressbook</span><span class="o">.</span><span class="n">Person</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">encoded_message</span><span class="p">)</span>
</pre></div>
</div>
<p>There are also packed versions:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">alice2</span> <span class="o">=</span> <span class="n">addressbook</span><span class="o">.</span><span class="n">Person</span><span class="o">.</span><span class="n">from_bytes_packed</span><span class="p">(</span><span class="n">alice</span><span class="o">.</span><span class="n">to_bytes_packed</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="rpc">
<h2>RPC<a class="headerlink" href="#rpc" title="Permalink to this headline">¶</a></h2>
<p>Cap&#8217;n Proto has a rich RPC protocol. You should read the <a class="reference external" href="http://kentonv.github.io/capnproto/rpc.html">RPC specification</a> as well as the <a class="reference external" href="http://kentonv.github.io/capnproto/cxxrpc.html">C++ RPC documentation</a> before using pycapnp&#8217;s RPC features. As with the serialization part of this library, the RPC component tries to be a very thin wrapper on top of the C++ API.</p>
<p>The examples below will be using <a class="reference external" href="https://github.com/jparyani/pycapnp/blob/master/examples/calculator.capnp">calculator.capnp</a>. Please refer to it to understand the interfaces that will be used.</p>
<div class="section" id="client">
<h3>Client<a class="headerlink" href="#client" title="Permalink to this headline">¶</a></h3>
<div class="section" id="starting-a-client">
<h4>Starting a CLient<a class="headerlink" href="#starting-a-client" title="Permalink to this headline">¶</a></h4>
<p>Starting a client is very easy:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">capnp</span>
<span class="kn">import</span> <span class="nn">calculator_capnp</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">capnp</span><span class="o">.</span><span class="n">TwoPartyClient</span><span class="p">(</span><span class="s">&#39;localhost:60000&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="restoring">
<h4>Restoring<a class="headerlink" href="#restoring" title="Permalink to this headline">¶</a></h4>
<p>Before you do anything else, you will need to restore a capability from the server. Refer to the <a class="reference external" href="http://kentonv.github.io/capnproto/rpc.html">Cap&#8217;n Proto docs</a> if you don&#8217;t know what this means:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">calculator</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">ez_restore</span><span class="p">(</span><span class="s">&#39;calculator&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">cast_as</span><span class="p">(</span><span class="n">calculator_capnp</span><span class="o">.</span><span class="n">Calculator</span><span class="p">)</span>
</pre></div>
</div>
<p>There&#8217;s two things worth noting here. First, we used the simpler <cite>ez_restore</cite> function. For servers that use a struct type as their Restorer, you will have to do the following instead:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">calculator</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">calculator_capnp</span><span class="o">.</span><span class="n">MyStructType</span><span class="o">.</span><span class="n">new_message</span><span class="p">(</span><span class="n">foo</span><span class="o">=</span><span class="s">&#39;bar&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">cast_as</span><span class="p">(</span><span class="n">calculator_capnp</span><span class="o">.</span><span class="n">Calculator</span><span class="p">)</span>
</pre></div>
</div>
<p>Secondly, you see that we are casting the capability that we receive. This is because capabilities are intrinsically dynamic, and they hold no run time type information, so we need to pick what interface to interpret them as.</p>
</div>
<div class="section" id="calling-methods">
<h4>Calling methods<a class="headerlink" href="#calling-methods" title="Permalink to this headline">¶</a></h4>
<p>There are 2 ways to call RPC methods. First the more verbose <cite>request</cite> syntax:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">request</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="n">evaluate_request</span><span class="p">()</span>
<span class="n">request</span><span class="o">.</span><span class="n">expression</span><span class="o">.</span><span class="n">literal</span> <span class="o">=</span> <span class="mi">123</span>
<span class="n">eval_promise</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">send</span><span class="p">()</span>
</pre></div>
</div>
<p>This creates a request for the method named &#8216;evaluate&#8217;, sets <cite>expression.literal</cite> in that calls parameters to 123, and then sends the request and returns a promise (all non-blocking).</p>
<p>The shorter syntax for calling methods is:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">promise</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="n">getOperator</span><span class="p">(</span><span class="n">op</span><span class="o">=</span><span class="s">&#39;add&#39;</span><span class="p">)</span>
<span class="c"># equivalent to:</span>
<span class="n">request</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="n">getOperator_request</span><span class="p">()</span>
<span class="n">request</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="s">&#39;add&#39;</span>
<span class="n">promise</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">send</span><span class="p">()</span>
</pre></div>
</div>
<p>The major shortcoming with this method is that it doesn&#8217;t work for complex fields, such as <cite>expression.literal</cite> from the first example.</p>
<p>Once you have a promise, there are 2 ways of getting to the result. The first is to wait for it:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">result</span> <span class="o">=</span> <span class="n">eval_promise</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</pre></div>
</div>
<p>The second is to build a promise chain by calling <cite>then</cite>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">do_stuff</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="o">...</span>

<span class="n">eval_promise</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">do_stuff</span><span class="p">)</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="pipelining">
<h4>Pipelining<a class="headerlink" href="#pipelining" title="Permalink to this headline">¶</a></h4>
<p>If a method returns values that are themselves capabilites, then you can access these fields before having to call <cite>wait</cite>. Doing this is called pipelining, and it allows Cap&#8217;n Proto to chain the calls without a round-trip occurring to the server:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># evaluate returns `value` which is itself an interface.</span>
<span class="c"># You can call a new method on `value` without having to call wait first</span>
<span class="n">read_promise</span> <span class="o">=</span> <span class="n">eval_promise</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">read_result</span> <span class="o">=</span> <span class="n">read_promise</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span> <span class="c"># only 1 wait call</span>
</pre></div>
</div>
<p>You can also chain promises with <cite>then</cite> and the same pipelining will occur:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">read_result</span> <span class="o">=</span> <span class="n">eval_promise</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ret</span><span class="p">:</span> <span class="n">ret</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="server">
<h3>Server<a class="headerlink" href="#server" title="Permalink to this headline">¶</a></h3>
<div class="section" id="starting-a-server">
<h4>Starting a Server<a class="headerlink" href="#starting-a-server" title="Permalink to this headline">¶</a></h4>
<p>Once you have a socket, it&#8217;s quite simple to start a server:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">server</span> <span class="o">=</span> <span class="n">capnp</span><span class="o">.</span><span class="n">TwoPartyServer</span><span class="p">(</span><span class="s">&#39;*:60000&#39;</span><span class="p">,</span> <span class="n">restore</span><span class="p">)</span>

<span class="n">server</span><span class="o">.</span><span class="n">run_forever</span><span class="p">()</span>
</pre></div>
</div>
<p>See the <a class="reference internal" href="#restore">Restore</a> section for an explanation of what the <cite>restore</cite> object needs to looks like.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You can also pass a socket with a <cite>fileno()</cite> method to TwoPartyServer. In that case, <cite>run_forever</cite> will not work, and you will have to use <cite>on_disconnect.wait()</cite>.</p>
</div>
</div>
<div class="section" id="implementing-a-server">
<h4>Implementing a Server<a class="headerlink" href="#implementing-a-server" title="Permalink to this headline">¶</a></h4>
<p>Here&#8217;s a part of how you would implement a Calculator server:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CalculatorImpl</span><span class="p">(</span><span class="n">calculator_capnp</span><span class="o">.</span><span class="n">Calculator</span><span class="o">.</span><span class="n">Server</span><span class="p">):</span>

    <span class="s">&quot;Implementation of the Calculator Cap&#39;n Proto interface.&quot;</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">_context</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">evaluate_impl</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="k">lambda</span> <span class="n">value</span><span class="p">:</span> <span class="nb">setattr</span><span class="p">(</span><span class="n">_context</span><span class="o">.</span><span class="n">results</span><span class="p">,</span> <span class="s">&#39;value&#39;</span><span class="p">,</span> <span class="n">ValueImpl</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">defFunction_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">params</span>
        <span class="n">context</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">FunctionImpl</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">paramCount</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getOperator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">OperatorImpl</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
</pre></div>
</div>
<p>Some major things worth noting.</p>
<ul>
<li><p class="first">You must inherit from <cite>your_module_capnp.YourInterface.Server</cite>, but don&#8217;t worry about calling __super__ in your __init__</p>
</li>
<li><p class="first">Method names of your class must either match the interface exactly, or have &#8216;_context&#8217; appended to it</p>
</li>
<li><p class="first">If your method name is exactly the same as the interface, then you will be passed all the arguments from the interface as keyword arguments, so your argument names must match the interface spec exactly. You will also receive a <cite>_context</cite> parameter which is equivalent to the C++ API&#8217;s Context. I highly recommend having <a href="#id2"><span class="problematic" id="id3">**</span></a>kwargs as well, so that even if your interface spec is upgraded and arguments were added, your server will still operate fine.</p>
</li>
<li><p class="first">Returns work with a bit of magic as well. If you return a promise, then it will be handled the same as if you returned a promise from a server method in the C++ API. Otherwise, your return statement will be filled into the results struct following the ordering in your spec, for example:</p>
<div class="highlight-python"><pre># capability.capnp file
interface TestInterface {
  foo @0 (i :UInt32, j :Bool) -&gt; (x: Text, i:UInt32);
}

# python code
class TestInterface(capability_capnp.TestInterface.Server):
    def foo(self, i, j, **kwargs):
        return str(j), i</pre>
</div>
</li>
<li><p class="first">If your method ends in _context, then you will only be passed a context parameter. You will have to access params and set results yourself manually. Returning promises still works as above, but you can&#8217;t return anything else from a method.</p>
</li>
</ul>
</div>
<div class="section" id="restore">
<h4>Restore<a class="headerlink" href="#restore" title="Permalink to this headline">¶</a></h4>
<p>Restoring can occur in either a class:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SimpleRestorer</span><span class="p">(</span><span class="n">test_capability_capnp</span><span class="o">.</span><span class="n">TestSturdyRefObjectId</span><span class="o">.</span><span class="n">Restorer</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref_id</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ref_id</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;testInterface&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Server</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Unrecognized ref passed to restore&#39;</span><span class="p">)</span>

<span class="o">...</span>

<span class="n">server</span> <span class="o">=</span> <span class="n">capnp</span><span class="o">.</span><span class="n">TwoPartyServer</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">SimpleRestorer</span><span class="p">())</span>
</pre></div>
</div>
<p>Where you inherit from StructType.Restorer, and the argument passed to restore will be cast to the proper type.</p>
<p>Otherwise, restore can be a function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="n">ref_id</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ref_id</span><span class="o">.</span><span class="n">as_struct</span><span class="p">(</span><span class="n">test_capability_capnp</span><span class="o">.</span><span class="n">TestSturdyRefObjectId</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;testInterface&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Server</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Unrecognized ref passed to restore&#39;</span><span class="p">)</span>

<span class="o">...</span>

<span class="n">server</span> <span class="o">=</span> <span class="n">capnp</span><span class="o">.</span><span class="n">TwoPartyServer</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">restore</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="full-examples">
<h2>Full Examples<a class="headerlink" href="#full-examples" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://github.com/jparyani/pycapnp/blob/master/examples">Full examples</a> are available on github. There is also an example of a very simplistic RPC available in <a class="reference external" href="https://github.com/jparyani/pycapnp/blob/master/test/test_rpc.py">test_rpc.py</a>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Quickstart</a><ul>
<li><a class="reference internal" href="#load-a-cap-n-proto-schema">Load a Cap&#8217;n Proto Schema</a><ul>
<li><a class="reference internal" href="#const-values">Const values</a></li>
</ul>
</li>
<li><a class="reference internal" href="#build-a-message">Build a message</a><ul>
<li><a class="reference internal" href="#initialize-a-new-cap-n-proto-object">Initialize a New Cap&#8217;n Proto Object</a></li>
<li><a class="reference internal" href="#list">List</a></li>
<li><a class="reference internal" href="#primitive-types">Primitive Types</a></li>
<li><a class="reference internal" href="#enums">Enums</a></li>
<li><a class="reference internal" href="#unions">Unions</a></li>
<li><a class="reference internal" href="#writing-to-a-file">Writing to a File</a></li>
</ul>
</li>
<li><a class="reference internal" href="#read-a-message">Read a message</a><ul>
<li><a class="reference internal" href="#reading-from-a-file">Reading from a file</a></li>
<li><a class="reference internal" href="#reading-fields">Reading Fields</a></li>
<li><a class="reference internal" href="#reading-unions">Reading Unions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#serializing-deserializing">Serializing/Deserializing</a><ul>
<li><a class="reference internal" href="#files">Files</a></li>
<li><a class="reference internal" href="#multi-message-files">Multi-message files</a></li>
<li><a class="reference internal" href="#dictionaries">Dictionaries</a></li>
<li><a class="reference internal" href="#byte-strings-buffers">Byte Strings/Buffers</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rpc">RPC</a><ul>
<li><a class="reference internal" href="#client">Client</a><ul>
<li><a class="reference internal" href="#starting-a-client">Starting a CLient</a></li>
<li><a class="reference internal" href="#restoring">Restoring</a></li>
<li><a class="reference internal" href="#calling-methods">Calling methods</a></li>
<li><a class="reference internal" href="#pipelining">Pipelining</a></li>
</ul>
</li>
<li><a class="reference internal" href="#server">Server</a><ul>
<li><a class="reference internal" href="#starting-a-server">Starting a Server</a></li>
<li><a class="reference internal" href="#implementing-a-server">Implementing a Server</a></li>
<li><a class="reference internal" href="#restore">Restore</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#full-examples">Full Examples</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="install.html"
                        title="previous chapter">Installation</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="capnp.html"
                        title="next chapter">API Reference</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/quickstart.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="capnp.html" title="API Reference"
             >next</a> |</li>
        <li class="right" >
          <a href="install.html" title="Installation"
             >previous</a> |</li>
        <li><a href="index.html">capnp 0.4.0-dev documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Author.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>